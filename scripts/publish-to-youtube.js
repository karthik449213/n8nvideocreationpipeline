// Upload a video file to YouTube with metadata generated by GPT

import dotenv from 'dotenv';
dotenv.config();
import fs from 'fs';
import { google } from 'googleapis';
import OpenAI from 'openai';

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

async function generateMetadata(idea) {
  const prompt = `Create a compelling YouTube title, description, and 10 tags for a short video about "${idea}" in the style of Zack D. Films.`;
  const resp = await client.responses.create({
    model: 'gpt-4o-mini',
    input: prompt,
    max_output_tokens: 300
  });
  const text = resp.output_text || '';
  try {
    return JSON.parse(text);
  } catch (e) {
    console.error('metadata parse failed:', text);
    throw e;
  }
}

async function upload(videoPath, idea) {
  // authenticate via GOOGLE_APPLICATION_CREDENTIALS environment variable
  const auth = new google.auth.GoogleAuth({ scopes: ['https://www.googleapis.com/auth/youtube.upload'] });
  const youtube = google.youtube({ version: 'v3', auth });

  const metadata = await generateMetadata(idea);

  const res = await youtube.videos.insert({
    part: ['snippet', 'status'],
    requestBody: {
      snippet: {
        title: metadata.title,
        description: metadata.description,
        tags: metadata.tags || []
      },
      status: {
        privacyStatus: 'public'
      }
    },
    media: {
      body: fs.createReadStream(videoPath)
    }
  });

  console.log('Uploaded video id', res.data.id);
  return res.data;
}

if (require.main === module) {
  const video = process.argv[2] || 'output.mp4';
  const idea = process.argv[3] || 'a mysterious forest adventure';
  upload(video, idea).catch(err => { console.error(err); process.exit(1); });
}
