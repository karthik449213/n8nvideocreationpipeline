// Upload a video file to YouTube with metadata generated by GPT

import dotenv from 'dotenv';
dotenv.config();
import fs from 'fs';
import { google } from 'googleapis';
import OpenAI from 'openai';
import path from 'path';

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

async function generateMetadata(idea) {
  const systemPrompt = `You are a YouTube content expert and SEO specialist for short-form cinematic videos.
Your job is to create compelling metadata that will help videos rank and get discovered.
Return ONLY valid JSON. No markdown, no extra text.`;

  const userPrompt = `For a 3D-style short film about: "${idea}"

Generate YouTube metadata in JSON format:
{
  "title": "A compelling title (under 100 chars)",
  "description": "A 2-3 sentence engaging description",
  "tags": ["tag1", "tag2", ..., "tag10"]
}

Requirements for title:
- Catchy and intriguing
- Under 100 characters
- Include relevant keywords

Requirements for description:
- 2-3 sentences
- Engaging and descriptive
- Include relevant keywords and hashtags

Requirements for tags:
- Exactly 10 tags
- Mix of broad (3D animation, short film) and specific tags
- Include "shortfilm", "3d", "animation"

Return ONLY the JSON object with no markdown or extra text.`;

  const resp = await client.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [
      {
        role: 'system',
        content: systemPrompt
      },
      {
        role: 'user',
        content: userPrompt
      }
    ],
    max_tokens: 400,
    temperature: 0.7
  });
  
  const text = resp.choices[0]?.message?.content || '';
  let metadata;
  try {
    metadata = JSON.parse(text);
  } catch (parseError) {
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('No JSON found in metadata response');
    metadata = JSON.parse(jsonMatch[0]);
  }

  if (!metadata.title || !metadata.description || !metadata.tags || !Array.isArray(metadata.tags)) {
    throw new Error('Invalid metadata structure');
  }
  
  return metadata;
}

async function upload(videoPath, idea) {
  try {
    if (!fs.existsSync(videoPath)) {
      throw new Error(`Video file not found: ${videoPath}`);
    }

    const stats = fs.statSync(videoPath);
    if (stats.size === 0) {
      throw new Error(`Video file is empty: ${videoPath}`);
    }

    console.error(`Uploading video: ${videoPath} (${(stats.size / 1024 / 1024).toFixed(2)} MB)`);

    if (!process.env.GOOGLE_APPLICATION_CREDENTIALS) {
      throw new Error('GOOGLE_APPLICATION_CREDENTIALS environment variable not set');
    }

    if (!fs.existsSync(process.env.GOOGLE_APPLICATION_CREDENTIALS)) {
      throw new Error(`Service account file not found: ${process.env.GOOGLE_APPLICATION_CREDENTIALS}`);
    }

    const auth = new google.auth.GoogleAuth({
      scopes: ['https://www.googleapis.com/auth/youtube.upload'],
      keyFile: process.env.GOOGLE_APPLICATION_CREDENTIALS
    });

    const youtube = google.youtube({
      version: 'v3',
      auth: await auth.getClient()
    });

    console.error('Generating metadata from GPT...');
    const metadata = await generateMetadata(idea);

    console.error('Starting YouTube upload...');
    const res = await youtube.videos.insert({
      part: ['snippet', 'status'],
      requestBody: {
        snippet: {
          title: metadata.title,
          description: metadata.description,
          tags: metadata.tags || [],
          categoryId: '24'
        },
        status: {
          privacyStatus: 'public',
          madeForKids: false
        }
      },
      media: {
        body: fs.createReadStream(videoPath)
      }
    }, {
      maxRedirects: 0,
      maxContentLength: Infinity,
      maxBodyLength: Infinity
    });

    const uploadedVideoId = res.data.id;
    console.log(JSON.stringify({
      videoId: uploadedVideoId,
      title: metadata.title,
      description: metadata.description,
      url: `https://www.youtube.com/watch?v=${uploadedVideoId}`
    }, null, 2));

    return {
      videoId: uploadedVideoId,
      metadata: metadata
    };

  } catch (error) {
    console.error('Upload error:', error.message);
    if (error.response && error.response.data) {
      console.error('YouTube error:', error.response.data);
    }
    process.exit(1);
  }
}

if (require.main === module) {
  const video = process.argv[2] || 'output.mp4';
  const idea = process.argv[3] || 'a mysterious forest adventure';
  upload(video, idea).catch(err => { console.error(err); process.exit(1); });
}
